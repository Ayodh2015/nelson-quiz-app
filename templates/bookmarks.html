{% extends "base.html" %}
{% block title %}Bookmarks ‚Äî Postgraduate Pead MSQ Exam Help Tool{% endblock %}

{% block extra_css %}
<style>
.bookmark-item { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 0.75rem; overflow: hidden; }
.bookmark-head { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.85rem; padding: 1rem 1.1rem; cursor: pointer; }
.bookmark-head:hover { background: rgba(255,255,255,0.02); }
.bookmark-meta { display: flex; gap: 0.45rem; flex-wrap: wrap; margin-bottom: 0.45rem; }
.bookmark-title { font-size: 0.92rem; color: var(--text); line-height: 1.6; }
.bookmark-right { display: flex; align-items: center; gap: 0.6rem; flex-shrink: 0; }
.bookmark-body { display: none; border-top: 1px solid var(--border); padding: 1rem 1.1rem 1.1rem; }
.bookmark-body.open { display: block; }
.chevron { transition: transform 0.2s; color: var(--text-muted); }
.chevron.open { transform: rotate(180deg); }
.opt-row { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.65rem 0.85rem; border-radius: 8px; margin-bottom: 0.4rem; font-size: 0.88rem; }
.opt-row.correct-ans { background: rgba(38,198,162,0.1); border: 1px solid rgba(38,198,162,0.3); }
.opt-row.wrong-ans { background: rgba(239,83,80,0.1); border: 1px solid rgba(239,83,80,0.3); }
.opt-row.neutral { background: rgba(255,255,255,0.03); border: 1px solid var(--border); }
.opt-label { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; font-weight: 700; font-size: 0.75rem; flex-shrink: 0; background: rgba(255,255,255,0.06); color: var(--text-muted); }
.tf-stmt-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; padding: 0.65rem 0.85rem; border-radius: 8px; margin-bottom: 0.4rem; font-size: 0.88rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); }
.tf-stmt-row.stmt-correct { background: rgba(38,198,162,0.08); border-color: rgba(38,198,162,0.25); }
.tf-stmt-row.stmt-wrong { background: rgba(239,83,80,0.08); border-color: rgba(239,83,80,0.25); }
.explanation-box { margin-top: 0.9rem; padding: 0.8rem 0.95rem; background: rgba(79,195,247,0.06); border-left: 3px solid var(--accent); border-radius: 0 8px 8px 0; }
.explanation-content p { margin-bottom: 0.45rem; }
.explanation-content p:last-child { margin-bottom: 0; }
.explanation-list { margin: 0.35rem 0 0.2rem 1.2rem; color: var(--text-muted); }
.explanation-list li { margin-bottom: 0.25rem; line-height: 1.6; }
.attempt-chip { font-size: 0.76rem; color: var(--text-muted); }
@media (max-width: 768px) {
    .bookmark-head { flex-direction: column; }
    .bookmark-right { width: 100%; justify-content: space-between; }
    .tf-stmt-row { flex-direction: column; }
    .tf-stmt-row > div:last-child { align-items: flex-start !important; }
}
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding-top: 2rem; max-width: 920px;">
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1.2rem;" class="fade-up">
        <div>
            <h1 style="font-size: 1.8rem; margin-bottom: 0.2rem;">Saved Bookmarks</h1>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Expand any question to review answers and explanations.</p>
        </div>
        <a href="/dashboard" class="btn btn-outline">‚Üê Dashboard</a>
    </div>

    {% if bookmarks %}
    <div class="card fade-up-delay">
        {% for b in bookmarks %}
        {% set attempt = b.last_attempt %}
        <div class="bookmark-item" id="bookmark-card-{{ b.question_id }}">
            <div class="bookmark-head" onclick="toggleBookmarkCard({{ loop.index }})">
                <div style="flex: 1;">
                    <div class="bookmark-meta">
                        <span class="badge {% if b.question_type == 'BOF' %}badge-blue{% else %}badge-gold{% endif %}">{{ b.question_type }}</span>
                        <span class="badge" style="background: rgba(255,255,255,0.05); color: var(--text-muted);">{{ b.section }}</span>
                        {% if attempt %}
                            {% if attempt.is_correct %}
                                <span class="badge badge-green">Last Attempt: Correct</span>
                            {% else %}
                                <span class="badge badge-red">Last Attempt: Review</span>
                            {% endif %}
                        {% else %}
                            <span class="badge" style="background: rgba(255,255,255,0.05); color: var(--text-muted);">Not Attempted</span>
                        {% endif %}
                    </div>
                    <div class="bookmark-title">{{ b.question_text }}</div>
                </div>

                <div class="bookmark-right">
                    <button type="button" class="btn btn-outline" onclick="removeBookmark(event, {{ b.question_id }})">Remove</button>
                    <span class="chevron" id="bookmark-chevron-{{ loop.index }}">‚ñº</span>
                </div>
            </div>

            <div class="bookmark-body" id="bookmark-body-{{ loop.index }}">
                {% if b.question_type == 'BOF' %}
                    {% for opt in b.bof_options %}
                    {% set user_answer = attempt.bof_answer if attempt else none %}
                    <div class="opt-row {% if opt.is_correct %}correct-ans{% elif user_answer == opt.option_label and not opt.is_correct %}wrong-ans{% else %}neutral{% endif %}">
                        <span class="opt-label">{{ opt.option_label }}</span>
                        <span>
                            {{ opt.option_text }}
                            {% if opt.is_correct %} ‚úì Correct answer{% endif %}
                            {% if user_answer == opt.option_label and not opt.is_correct %} ‚úó Your answer{% endif %}
                        </span>
                    </div>
                    {% endfor %}
                    {% if attempt and attempt.bof_answer %}
                    <div class="attempt-chip">Your last selected option: <strong>{{ attempt.bof_answer }}</strong></div>
                    {% endif %}
                {% else %}
                    {% for stmt in b.tf_statements %}
                    {% set user_ans = attempt.tf_answers[loop.index0] if attempt and attempt.tf_answers and loop.index0 < attempt.tf_answers|length else none %}
                    {% set is_stmt_correct = user_ans == stmt.is_true if user_ans is not none else false %}
                    <div class="tf-stmt-row {% if is_stmt_correct %}stmt-correct{% else %}stmt-wrong{% endif %}">
                        <span style="font-size: 0.88rem; flex: 1;">
                            <strong style="color: var(--text-muted);">{{ stmt.statement_number }}.</strong> {{ stmt.statement_text }}
                        </span>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.2rem; flex-shrink: 0;">
                            <span style="font-size: 0.78rem; color: var(--text-muted);">Correct: <strong style="color: {% if stmt.is_true %}var(--accent-green){% else %}var(--danger){% endif %};">{{ 'TRUE' if stmt.is_true else 'FALSE' }}</strong></span>
                            <span style="font-size: 0.78rem; color: var(--text-muted);">Your last answer: <strong style="color: {% if user_ans is none %}var(--text-muted){% elif is_stmt_correct %}var(--accent-green){% else %}var(--danger){% endif %};">
                                {% if user_ans is none %}‚Äî{% elif user_ans %}TRUE{% else %}FALSE{% endif %}
                            </strong></span>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}

                {% if b.explanation %}
                <div class="explanation-box">
                    <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); font-weight: 600; margin-bottom: 0.35rem;">Key Learning Point</div>
                    <div class="explanation-content">{{ b.explanation_formatted | safe }}</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card fade-up-delay" style="text-align: center; padding: 2.5rem;">
        <div style="font-size: 2.2rem; margin-bottom: 0.75rem;">üîñ</div>
        <h2 style="font-size: 1.2rem; margin-bottom: 0.35rem;">No bookmarks yet</h2>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">Bookmark questions during a quiz to review them here.</p>
        <a href="/start" class="btn btn-success">Start Quiz</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleBookmarkCard(n) {
    const body = document.getElementById('bookmark-body-' + n);
    const chev = document.getElementById('bookmark-chevron-' + n);
    if (!body || !chev) return;
    body.classList.toggle('open');
    chev.classList.toggle('open');
}

async function removeBookmark(e, questionId) {
    e.stopPropagation();
    const res = await fetch('/bookmark/' + questionId, { method: 'POST' });
    const data = await res.json();

    if (data.status === 'removed') {
        const card = document.getElementById('bookmark-card-' + questionId);
        if (card) card.remove();
        if (!document.querySelector('[id^="bookmark-card-"]')) {
            window.location.reload();
        }
        return;
    }

    alert(data.message || 'Unable to remove bookmark.');
}
</script>
{% endblock %}
